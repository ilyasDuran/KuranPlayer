<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Kur'an-ƒ± Kerim Player Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#27ae60">
    
    <script src="kurandata.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #27ae60;
            --bg: #eef2f3;
            --card-bg: #ffffff;
            --item-h: 60px; 
            --wrapper-h: 300px;
            --text: #2c3e50;
            --input-bg: #f1f3f5;
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        [data-theme="dark"] {
            --primary: #ecf0f1;
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #f5f5f5;
            --input-bg: #3d3d3d;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            margin: 0;
            display: flex; justify-content: center; align-items: center;
            min-height: 100dvh; color: var(--text);
            transition: background 0.3s; overflow: hidden;
        }

        .container {
            background: var(--card-bg); width: 100%; max-width: 420px;
            height: 100dvh; display: flex; flex-direction: column;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); overflow: hidden; position: relative;
        }

        @media (min-width: 481px) { .container { height: 850px; border-radius: 30px; margin: 20px; } }

        .header {
            padding: 15px; padding-top: env(safe-area-inset-top, 15px);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.1); z-index: 10;
        }

        .header-btns { display: flex; gap: 15px; }
        .header-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--accent); padding: 5px; }

        .settings-panel {
            position: absolute; top: 0; right: -100%; width: 85%; height: 100%;
            background: var(--card-bg); z-index: 300;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -10px 0 30px rgba(0,0,0,0.2); padding: 25px;
            box-sizing: border-box; overflow-y: auto;
        }
        .settings-panel.open { right: 0; }
        .settings-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 10px; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 250; backdrop-filter: blur(2px); }
        
        .setting-item { margin-bottom: 25px; }
        .setting-item label { display: block; font-size: 0.85rem; margin-bottom: 10px; font-weight: bold; opacity: 0.8; }
        .setting-item select { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); background: var(--input-bg); color: var(--text); font-size: 1rem; outline: none; }

        .switch-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-switch { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-switch:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-switch { background-color: var(--accent); }
        input:checked + .slider-switch:before { transform: translateX(24px); }

        .wave-container { display: flex; align-items: center; justify-content: center; gap: 4px; height: 40px; margin: 10px 0; }
        .wave-bar { width: 4px; height: 8px; background: var(--accent); border-radius: 4px; transition: height 0.2s; }
        .playing .wave-bar { animation: waveAnim 1s ease-in-out infinite; }
        @keyframes waveAnim { 0%, 100% { height: 8px; } 50% { height: 35px; } }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; }

        .progress-container { width: 90%; height: 6px; background: var(--input-bg); border-radius: 10px; margin: 0 auto 15px auto; cursor: pointer; overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.1s linear; }

        .picker-section { flex: 1; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.02); position: relative; }
        .drum-wrapper { position: relative; height: var(--wrapper-h); width: 100%; overflow: hidden; }
        .drum-list { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; padding-top: 120px; padding-bottom: 120px; box-sizing: border-box; scrollbar-width: none; scroll-behavior: smooth; }
        .drum-list::-webkit-scrollbar { display: none; }
        .drum-item { height: var(--item-h); line-height: var(--item-h); text-align: center; font-size: 1.2rem; color: #888; scroll-snap-align: center; cursor: pointer; }
        .drum-item.active { color: var(--accent); font-weight: 800; transform: scale(1.15); }
        .selection-mask { position: absolute; top: 120px; left: 10%; right: 10%; height: var(--item-h); border-top: 2px solid var(--accent); border-bottom: 2px solid var(--accent); background: rgba(39, 174, 96, 0.05); pointer-events: none; border-radius: 8px; }

        .controls-panel { 
            background: var(--card-bg); padding: 20px; 
            padding-bottom: calc(var(--safe-bottom) + 10px); 
            border-top: 1px solid rgba(0,0,0,0.1); z-index: 10;
        }
        .status-box { height: 65px; text-align: center; margin-bottom: 15px; font-size: 0.85rem; line-height: 1.4; display: flex; flex-direction: column; justify-content: center; }

        .inputs-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 20px; }
        .input-item { background: var(--input-bg); padding: 8px; border-radius: 12px; text-align: center; }
        .input-item label { font-size: 0.55rem; opacity: 0.7; display: block; margin-bottom: 3px; font-weight: bold; }
        .input-item input { width: 100%; border: none; background: transparent; text-align: center; color: var(--text); font-weight: bold; font-size: 0.9rem; outline: none; }

        .btn-group { display: flex; gap: 10px; }
        .btn { border: none; border-radius: 15px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-play { background: var(--accent); color: white; flex: 2; height: 60px; font-size: 1.1rem; }
        .btn-nav { background: var(--input-bg); color: var(--text); flex: 1; height: 60px; font-size: 1.3rem; }

        #toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.85rem; display: none; z-index: 400; }
    </style>
</head>
<body data-theme="light">

<div class="container">
    <div id="toast">Hata!</div>
    <div id="overlay" class="overlay" onclick="toggleSettings()"></div>

    <div id="settingsPanel" class="settings-panel">
        <div class="settings-header">
            <h3 style="margin:0">Ayarlar</h3>
            <button onclick="toggleSettings()" class="header-btn">‚úï</button>
        </div>
        <div class="setting-item">
            <label>OKUYUCU (HAFIZ)</label>
            <select id="reciterSelect" onchange="changeReciter()">
                <option value="afasy">Mishary Rashid Al-Afasy</option>
                <option value="ghamadi">Saad Al-Ghamdi</option>
                <option value="minshawi">Mohamed Siddiq Al-Minshawi</option>
                <option value="husary">Mahmoud Khalil Al-Husary</option>
                <option value="shatree">Abu Bakr al-Shatri</option>
            </select>
        </div>
        <div class="setting-item">
            <div class="switch-row">
                <label>SONRAKƒ∞ SUREYE OTOMATƒ∞K GE√á</label>
                <label class="switch">
                    <input type="checkbox" id="autoNextSwitch">
                    <span class="slider-switch"></span>
                </label>
            </div>
        </div>
        <div class="setting-item">
            <label>OKUMA HIZI: <span id="speedV">1.0x</span></label>
            <input type="range" id="speedR" min="0.5" max="2" step="0.1" value="1" style="width:100%; accent-color:var(--accent);">
        </div>
        <div class="setting-item">
            <label>AYET ARASI BEKLEME: <span id="waitV">0sn</span></label>
            <input type="range" id="waitR" min="0" max="15" step="1" value="0" style="width:100%; accent-color:var(--accent);">
        </div>
    </div>

    <div class="header">
        <span style="font-weight: bold;">üìñ Kur'an Player Pro</span>
        <div class="header-btns">
            <button id="theme-toggle" class="header-btn" onclick="toggleTheme()">üåô</button>
            <button class="header-btn" onclick="toggleSettings()">‚öôÔ∏è</button>
        </div>
    </div>

    <div id="wave-box" class="wave-container">
        <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
    </div>

    <div class="progress-container" onclick="seekAudio(event)">
        <div id="progress-bar"></div>
    </div>

    <div class="picker-section">
        <div class="drum-wrapper">
            <div class="selection-mask"></div>
            <div id="sureDrum" class="drum-list"></div>
        </div>
    </div>

    <div class="controls-panel">
        <div id="status" class="status-box">Y√ºkleniyor...</div>
        <div class="inputs-row">
            <div class="input-item"><label>BA≈ûLA</label><input type="number" id="startA" value="1" min="1"></div>
            <div class="input-item"><label>Bƒ∞Tƒ∞≈û</label><input type="number" id="endA" value="1" min="1"></div>
            <div class="input-item"><label>AYET TEKRAR</label><input type="number" id="repA" value="1" min="1"></div>
            <div class="input-item"><label>SURE TEKRAR</label><input type="number" id="sureRepA" value="1" min="1"></div>
        </div>
        <div class="btn-group">
            <button class="btn btn-nav" onclick="nav(-1)">‚¨Ö</button>
            <button class="btn btn-play" id="pBtn" onclick="toggle()">BA≈ûLAT</button>
            <button class="btn btn-nav" onclick="nav(1)">‚û°</button>
        </div>
    </div>
</div>

<audio id="audMain"></audio>
<audio id="audPreload" preload="auto"></audio>

<script>
    const drum = document.getElementById('sureDrum'),
          audMain = document.getElementById('audMain'),
          audPreload = document.getElementById('audPreload'),
          pBtn = document.getElementById('pBtn'),
          status = document.getElementById('status'),
          speedR = document.getElementById('speedR'),
          waitR = document.getElementById('waitR'),
          progressBar = document.getElementById('progress-bar'),
          waveBox = document.getElementById('wave-box'),
          settingsPanel = document.getElementById('settingsPanel'),
          overlay = document.getElementById('overlay'),
          reciterSelect = document.getElementById('reciterSelect'),
          autoNextSwitch = document.getElementById('autoNextSwitch'),
          startInp = document.getElementById('startA'),
          endInp = document.getElementById('endA'),
          repInp = document.getElementById('repA'),
          sureRepInp = document.getElementById('sureRepA');

    let sIdx = 0, cA = 1, tA = 1, rM = 1, rL = 0, playing = false, timer = null, currentReciter = 'afasy';
    let sRM = 1, sRL = 1;
    const ITEM_H = 60;

    function init() {
        if (typeof Sureler === 'undefined') return;
        Sureler.forEach((s, idx) => {
            const d = document.createElement('div');
            d.className = 'drum-item'; d.innerText = s[0];
            d.onclick = () => drum.scrollTo({ top: idx * ITEM_H, behavior: 'smooth' });
            drum.appendChild(d);
        });

        // TEMA Y√úKLEME VE SEMBOL√ú D√úZELTME
        const savedTheme = localStorage.getItem('quran_theme') || 'light';
        document.body.setAttribute('data-theme', savedTheme);
        document.getElementById('theme-toggle').innerText = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

        drum.addEventListener('scroll', () => {
            const i = Math.round(drum.scrollTop / ITEM_H);
            if (i !== sIdx && i >= 0 && i < Sureler.length) {
                sIdx = i;
                // Sure deƒüi≈ütiƒüinde deƒüerleri resetle (Sadece kaydƒ±rarak deƒüi≈üimde)
                startInp.value = 1;
                endInp.value = Sureler[sIdx][3];
                updateUIAfterSuraChange();
            }
        });

        [startInp, endInp, repInp, sureRepInp].forEach(inp => {
            inp.addEventListener('change', () => {
                if (inp.value < 1 || inp.value === "") inp.value = 1;
                saveState();
            });
        });

        const savedState = JSON.parse(localStorage.getItem('quran_pro_v5')) || {};
        currentReciter = localStorage.getItem('quran_reciter') || 'afasy';
        reciterSelect.value = currentReciter;
        speedR.value = savedState.speed || 1;
        waitR.value = savedState.wait || 0;
        autoNextSwitch.checked = savedState.autoNext || false;
        
        document.getElementById('speedV').innerText = speedR.value + "x";
        document.getElementById('waitV').innerText = waitR.value + "sn";

        setTimeout(() => {
            drum.scrollTo({ top: (savedState.sIdx || 0) * ITEM_H });
            // ƒ∞lk a√ßƒ±lƒ±≈üta kaydedilen deƒüerleri y√ºkle (Scroll event'i ezmeden √∂nce)
            startInp.value = savedState.start || 1;
            endInp.value = savedState.end || Sureler[savedState.sIdx || 0][3];
            repInp.value = savedState.rep || 1;
            sureRepInp.value = savedState.sureRep || 1;
            updateUIAfterSuraChange();
        }, 300);
    }

    function toggleSettings() {
        const isOpen = settingsPanel.classList.toggle('open');
        overlay.style.display = isOpen ? 'block' : 'none';
        if(!isOpen) saveState();
    }

    function changeReciter() {
        currentReciter = reciterSelect.value;
        localStorage.setItem('quran_reciter', currentReciter);
        if (playing) play();
    }

    function updateUIAfterSuraChange() {
        Array.from(drum.children).forEach((it, idx) => it.classList.toggle('active', idx === sIdx));
        const maxAyah = Sureler[sIdx][3];
        startInp.max = maxAyah;
        endInp.max = maxAyah;
        status.innerHTML = `<b>${Sureler[sIdx][0]}</b> hazƒ±r.`;
        saveState();
    }

    audMain.ontimeupdate = () => {
        if (audMain.duration) progressBar.style.width = (audMain.currentTime / audMain.duration) * 100 + "%";
    };

    function seekAudio(e) {
        if (!playing) return;
        const rect = e.currentTarget.getBoundingClientRect();
        audMain.currentTime = ((e.clientX - rect.left) / rect.width) * audMain.duration;
    }

    function getAudioUrl(sura, ayah) {
        const s = String(Sureler[sura][1]).padStart(3, '0');
        const a = String(ayah).padStart(3, '0');
        return `https://tanzil.net/res/audio/${currentReciter}/${s}${a}.mp3`;
    }

    async function play() {
        if (!playing) return;
        if (cA > tA) {
            sRL--;
            if (sRL > 0) {
                // Sure tekrar ederken deƒüerleri RESETLEME!
                cA = parseInt(startInp.value); rL = rM; play();
            } else {
                if (autoNextSwitch.checked && sIdx < Sureler.length - 1) {
                    sIdx++;
                    drum.scrollTo({ top: sIdx * ITEM_H, behavior: 'smooth' });
                    setTimeout(() => {
                        // Yeni sureye ge√ßtiƒüinde 1 ve Max'a resetle
                        cA = 1; tA = Sureler[sIdx][3];
                        startInp.value = 1; endInp.value = tA;
                        sRM = parseInt(sureRepInp.value); sRL = sRM; rL = rM;
                        play();
                    }, 800);
                } else {
                    status.innerHTML = "‚ú® <b>Tamamlandƒ±</b>"; stopPlay();
                }
            }
            return;
        }

        try {
            waveBox.classList.add('playing');
            audMain.src = getAudioUrl(sIdx, cA);
            audMain.playbackRate = speedR.value;
            await audMain.play();
            let nextA = (rL > 1) ? cA : cA + 1;
            if (nextA <= tA) audPreload.src = getAudioUrl(sIdx, nextA);
            status.innerHTML = `<b>${Sureler[sIdx][0]}</b><br>Ayet: ${cA}/${tA} | Tekrar: ${rM - rL + 1}/${rM}<br>Sure Tekrar: ${sRM - sRL + 1}/${sRM}`;
        } catch (e) {
            showToast("Ses y√ºklenemedi."); stopPlay();
        }
    }

    audMain.onended = () => {
        rL--;
        if (rL <= 0) { rL = rM; cA++; }
        const waitTime = parseInt(waitR.value) * 1000;
        if (waitTime > 0 && (cA <= tA || sRL > 1)) {
            status.innerHTML += "<br><small>Bekleniyor...</small>";
            timer = setTimeout(play, waitTime);
        } else { play(); }
    };

    function toggle() {
        if (!playing) {
            cA = Math.max(1, parseInt(startInp.value));
            tA = Math.max(1, parseInt(endInp.value));
            rM = Math.max(1, parseInt(repInp.value));
            sRM = Math.max(1, parseInt(sureRepInp.value));
            if (cA > tA) { showToast("Ayet aralƒ±ƒüƒ± hatalƒ±!"); return; }
            rL = rM; sRL = sRM; playing = true;
            pBtn.innerText = "DURDUR"; pBtn.style.background = "#e67e22";
            play();
        } else { stopPlay(); }
    }

    function stopPlay() {
        audMain.pause(); playing = false;
        waveBox.classList.remove('playing');
        clearTimeout(timer);
        pBtn.innerText = "BA≈ûLAT"; pBtn.style.background = "var(--accent)";
        progressBar.style.width = "0%";
    }

    function nav(step) {
        if (!playing) return;
        clearTimeout(timer);
        cA += step; if (cA < 1) cA = 1;
        rL = rM; play();
    }

    function saveState() {
        localStorage.setItem('quran_pro_v5', JSON.stringify({
            sIdx, speed: speedR.value, wait: waitR.value,
            start: startInp.value, end: endInp.value,
            rep: repInp.value, sureRep: sureRepInp.value,
            autoNext: autoNextSwitch.checked
        }));
    }

    function toggleTheme() {
        const next = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', next);
        document.getElementById('theme-toggle').innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('quran_theme', next);
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    speedR.oninput = () => { document.getElementById('speedV').innerText = speedR.value + "x"; saveState(); };
    waitR.oninput = () => { document.getElementById('waitV').innerText = waitR.value + "sn"; saveState(); };

    window.onload = init;
</script>
</body>
</html>
